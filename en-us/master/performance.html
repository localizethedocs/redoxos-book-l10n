<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance - The Redox Operating System</title>


        <!-- Custom HTML head -->
        <style>
        .light .redox-logo {
            content: url("assets/redox_light_512.png");
        }
        .rust .redox-logo {
            content: url("assets/redox_light_512.png");
        }
        .coal .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        .navy .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        .ayu .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        </style>
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="This book carefully describes the design, implementation, direction, and structure of Redox, the operating system.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Redox Operating System</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="performance"><a class="header" href="#performance">Performance</a></h1>
<ul>
<li><a href="#kernel-profiling">Kernel Profiling</a></li>
<li><a href="#benchmarks">Benchmarks</a></li>
</ul>
<h2 id="kernel-profiling"><a class="header" href="#kernel-profiling">Kernel Profiling</a></h2>
<p>You can create a flamegraph showing the kernel's most frequent operations, using time-based sampling.</p>
<p>One CPU core is allocated for capturing the profiling data. The instruction pointers of the other cores are copied at regular intervals. If the sampled core is in supervisor mode, the instruction address is added to the profile data. If it is in user mode, it is ignored. The <code>profiled</code> daemon copies the captured profile data to a file.</p>
<p>This is an example flamegraph. If you open the image in a new tab, there is useful mouse-over behavior.</p>
<p><img src="./assets/kernel_flamegraph.svg" alt="Kernel Flamegraph" title="Kernel Flamegraph" /></p>
<p>The steps below are for profiling on <code>x86_64</code>, running in <code>QEMU</code>. It is possible to run the tests on real hardware, although retrieving the data may be challenging.</p>
<h3 id="setup"><a class="header" href="#setup">Setup</a></h3>
<ol>
<li>
<p>Open a terminal window in the <code>redox</code> directory.</p>
</li>
<li>
<p>Install tools:</p>
</li>
</ol>
<pre><code class="language-sh">cargo install redox-kprofiling
</code></pre>
<pre><code class="language-sh">cargo install inferno
</code></pre>
<ol start="3">
<li>
<p>Make sure you have the kernel source by running <code>make f.kernel</code>.</p>
</li>
<li>
<p>Open a second terminal window in the directory <code>recipes/core/kernel</code></p>
</li>
<li>
<p>Edit <code>recipe.toml</code> in the <code>kernel</code> directory. First, comment out the <code>[source]</code> section so the build process does not try to fetch the source again.</p>
</li>
</ol>
<pre><code class="language-toml"># [source]
# git = "https://gitlab.redox-os.org/redox-os/kernel.git"
</code></pre>
<ol start="6">
<li>You need to enable the <code>profiling</code> feature for the kernel. This can be done two ways, either in <code>recipe.toml</code> or in <code>source/Cargo.toml</code>. For <code>recipe.toml</code>, add the line <code>--features profiling \</code> to the <code>cargo</code> command. (The backslash is needed to continue the command.)</li>
</ol>
<pre><code class="language-sh">cargo rustc \
    --bin kernel \
    --features profiling \ &lt;- Add this line
    ...
</code></pre>
<p>If you prefer to modify <code>source/Cargo.toml</code>, then you can add <code>profiling</code> to the default features. (This also helps if you are using an IDE.)</p>
<pre><code class="language-toml">[features]
default = ["profiling", ...]
</code></pre>
<ol start="7">
<li>
<p>(Optional) In the <code>kernel</code> directory, edit <code>source/src/profiling.rs</code>: set <code>HARDCODED_CPU_COUNT</code> to the number of CPU cores on the machine that will be profiled, minus one (one core is dedicated to profiling). Also consider changing the size of the buffers used for recording profile data, <code>const N: usize</code>, depending on how much RAM is available. 64MiB is a reasonable minimum, but if you have the memory available, you can increase it to 256MiB.</p>
</li>
<li>
<p>The profiling code is written primarily for QEMU, but for real hardware, consider commenting out the <code>serio_command</code> code in <code>profiling.rs</code>, which is to enable or disable profiling.</p>
</li>
<li>
<p>In your first terminal window, from the <code>redox</code> directory, create the filesystem config <code>config/x86_64/my_profiler.toml</code> with the following content.</p>
</li>
</ol>
<pre><code class="language-toml">include = [ "minimal.toml" ]

# General settings
[general]
# Filesystem size in MiB
filesystem_size = 1024

# Package settings
[packages]
# This is the profiling daemon
profiled = {}
# Add any other packages you need for testing here

# Init script to start the profile daemon
# The sequence number "01" ensures it will be started right after the drivers
[[files]]
path = "/usr/lib/init.d/01_profile"
data = """
profiled
"""

[[files]]
path = "/usr/bin/perf_tests.sh"
data = """
dd bs=4k count=100000 &lt; /scheme/zero &gt; /scheme/null
"""

# Script to perform performance tests - add your tests here
# If you will be testing manually, you don't need this section
[[files]]
path = "/usr/lib/init.d/99_tests"
data = """
echo Waiting for startup to complete...
sleep 5
echo
echo Running tests...
ion -x /usr/bin/perf_tests.sh
echo Shutting down...
shutdown
"""
</code></pre>
<ol start="10">
<li>In the <code>redox</code> directory, create the file <code>.config</code> with the following content:</li>
</ol>
<pre><code class="language-make"># This needs to match the name of your filesystem config file
CONFIG_NAME=my_profiler
# Core count; this needs to be HARDCODED_CPU_COUNT+1
QEMU_SMP=5
# Memory size in MiB; 8GiB is the minimum, larger is better
QEMU_MEM=8192
# Don't use the display
gpu=no
</code></pre>
<ol start="11">
<li>In the <code>redox</code> terminal window, run the <code>make rp.kernel</code> (or <code>make rebuild</code> if needed) command.</li>
</ol>
<h3 id="profiling"><a class="header" href="#profiling">Profiling</a></h3>
<ol start="12">
<li>
<p>In your <code>redox</code> terminal window, run <code>make qemu</code> or your preferred VM command, and perform your testing. You will see console messages indicating that profile data is being logged. <strong>Exit QEMU or your VM</strong> before proceeding, if it did not exit automatically.</p>
</li>
<li>
<p>In the <code>redox</code> directory, run the following commands.</p>
</li>
</ol>
<pre><code class="language-sh"># Create a directory for your data
mkdir my_profiler_data
</code></pre>
<pre><code class="language-sh"># Make the Redox filesystem accessible at the path based on CONFIG_NAME
make mount
</code></pre>
<pre><code class="language-sh"># Copy the profiling data from the Redox image to your directory
cp build/x86_64/my_profiler/filesystem/root/profiling.txt my_profiler_data
</code></pre>
<pre><code class="language-sh"># Important - unmount the Redox filesystem
make unmount
</code></pre>
<ol start="15">
<li><code>cd</code> into the new directory and generate a symbol table for the kernel.</li>
</ol>
<pre><code class="language-sh">cd my_profiler_data
</code></pre>
<pre><code class="language-sh">nm -CS ../recipes/core/kernel/target/x86_64-unknown-redox/build/kernel &gt; kernel_syms.txt
</code></pre>
<ol start="16">
<li>
<p>The next step is to determine the TSC frequency. TL;DR - just use your CPU clock rate in GHz. The TSC is a counter that tracks the clock cycles since the system was powered on. The TSC frequency can vary based when power saving is enabled, but Redox does not implement this yet, so CPU GHz should work fine.</p>
</li>
<li>
<p>Determine what formatting options you want for your flamegraph - 'i' for relaxed checking of function length, 'o' for reporting function plus offset rather than just function, 'x' for both grouping by function and with offset.</p>
</li>
<li>
<p>In the directory <code>my_profiler_data</code>, generate the flamegraph.</p>
</li>
</ol>
<pre><code class="language-sh">redox-kprofiling profiling.txt kernel_syms.txt x y.z | inferno-collapse-perf | inferno-flamegraph &gt; kernel_flamegraph.svg
</code></pre>
<p>Replace the <code>x</code> with your preferred formatting options. Replace the <code>y.z</code> with your TSC/CPU Clock frequency in GHz (<code>2.2</code>, for example).</p>
<p>Then view your flamegraph in a browser.</p>
<pre><code class="language-sh">firefox kernel_flamegraph.svg
</code></pre>
<h3 id="real-hardware-untested"><a class="header" href="#real-hardware-untested">Real Hardware (untested)</a></h3>
<ul>
<li>
<p>You need to set <code>HARDCODED_CPU_COUNT</code> to the number of actual CPU cores - 1, and there must be at least 512 MiB reserved per core.</p>
</li>
<li>
<p>Boot the system, and when you're done profiling, kill <code>profiled</code> and extract <code>/root/profiling.txt</code> (Details TBD)</p>
</li>
</ul>
<h2 id="benchmarks"><a class="header" href="#benchmarks">Benchmarks</a></h2>
<p>This section give some commands to benchmark Redox.</p>
<!--
- CPU benchmark
TODO: port the sha256sum tool to redox
```sh
dd bs=1M count=1024 if=/scheme/zero | sha256sum
```
-->
<ul>
<li>RAM benchmark</li>
</ul>
<pre><code class="language-sh">dd bs=1M count=1024 if=/scheme/zero of=/scheme/null
</code></pre>
<ul>
<li>Filesystem read speed benchmark</li>
</ul>
<p>(Add the <code>neverball</code> recipe on your filesystem image, you can also install it with the <code>sudo pkg install neverball</code> command)</p>
<pre><code class="language-sh">dd bs=1M count=256 if=/usr/games/neverball/neverball of=/scheme/null conv=fdatasync
</code></pre>
<ul>
<li>Filesystem write speed benchmark</li>
</ul>
<p>(Add the <code>neverball</code> recipe on your filesystem image, you can also install it with the <code>sudo pkg install neverball</code> command)</p>
<pre><code class="language-sh">dd bs=1M count=256 if=/usr/games/neverball/neverball of=fs_write_speed_bench conv=fdatasync
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ci.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="syscall-debug.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ci.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="syscall-debug.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
