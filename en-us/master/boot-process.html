<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Boot Process - The Redox Operating System</title>


        <!-- Custom HTML head -->
        <style>
        .light .redox-logo {
            content: url("assets/redox_light_512.png");
        }
        .rust .redox-logo {
            content: url("assets/redox_light_512.png");
        }
        .coal .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        .navy .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        .ayu .redox-logo {
            content: url("assets/redox_dark_512.png");
        }
        </style>
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="This book carefully describes the design, implementation, direction, and structure of Redox, the operating system.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Redox Operating System</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="boot-process"><a class="header" href="#boot-process">Boot Process</a></h1>
<h2 id="boot-loader"><a class="header" href="#boot-loader">Boot Loader</a></h2>
<p>The boot loader source can be found in <code>cookbook/recipes/bootloader/source</code> after a successful build or in the <a href="https://gitlab.redox-os.org/redox-os/bootloader">Boot Loader</a> repository.</p>
<h3 id="bios-boot"><a class="header" href="#bios-boot">BIOS Boot</a></h3>
<p>BIOS Boot is a boot process that dates back to the <a href="https://dosdays.co.uk/topics/pc_bios.php">IBM PC</a>. Because of its lengthy history, BIOS starts up in 16-bit mode (Real Mode), and the boot loader needs to load in multiple stages to move into higher bit environments. The firmware will execute the boot sector located in the first sector of the main storage device, which is known as the stage 1 bootloader (<a href="https://wiki.osdev.org/Boot_Sequence#Master_Boot_Record">OSDev Wiki</a>).</p>
<p>The stage 1 bootloader is written in Assembly and can be found in <code>asm/x86-unknown-none/stage1.asm</code>. The stage 1 main task is to allow reading of the whole disk to load stage 2 in another sector of the storage device. The stage 2 bootloader is also written in Assembly. The main task is transferring <a href="https://wiki.osdev.org/BIOS#BIOS_functions">BIOS functions</a> from real mode to protected mode (32-bit), then switches to protected mode or long mode (64-bit) and finally loads the Rust-written boot loader, called stage 3.</p>
<p>These three boot loader stages are combined in one executable written to the first megabyte of the storage device. The first code that is executed in Rust-written code is <code>pub extern "C" fn start()</code> in <code>src/os/bios/mod.rs</code>. At this point, the bootloader follows the same common boot process on all boot methods, which can be seen in a later section.</p>
<h3 id="uefi-boot"><a class="header" href="#uefi-boot">UEFI Boot</a></h3>
<p>Redox supports UEFI booting on x86-64, ARM64, and RISC-V 64-bit machines. UEFI starts up in 64-bit mode; thus, the boot process doesn't need multiple stages. The firmware will find the EFI System Partition (ESP) on the storage device, then load and execute PE32+ UEFI programs typically located at <code>/EFI/BOOT/BOOTX64.efi</code> (<a href="https://wiki.osdev.org/UEFI#Bootable_UEFI_applications">OSDev Wiki</a>).</p>
<p>In the case of our bootloader, the first code that is executed is <code>pub extern "C" fn main()</code> in <code>src/os/uefi/mod.rs</code>. At this point, the bootloader follows the same common boot process on all boot methods, which can be seen in a later section.</p>
<h3 id="common-boot-process"><a class="header" href="#common-boot-process">Common boot process</a></h3>
<p>The bootloader initializes the memory map and the display mode, both of which rely on firmware mechanisms that are not accessible after control is switched to the kernel. The bootloader then finds the RedoxFS boot partition on the disk and loads <code>/boot/kernel</code> and <code>/boot/initfs</code> files into memory.</p>
<p>For a live disk, it does load the whole partition into memory. It then loads <code>/boot/kernel</code> and <code>/boot/initfs</code> also at a different location in memory.</p>
<p>After the kernel and initfs have been loaded, it sets up a virtual paging for kernel and environment variables, including the location of the RedoxFS boot partition to be passed into it. Then, it maps the kernel to its expected virtual address and jumps to its entry function.</p>
<h2 id="kernel"><a class="header" href="#kernel">Kernel</a></h2>
<p>The Redox kernel is a single ELF program in <code>/boot/kernel</code>. This kernel performs (fairly significant) architecture-specific initialization in the <code>kstart</code> function before jumping to the <code>kmain</code> function. At this point, the user-space bootstrap, a specially prepared executable that limits the required kernel parsing, sets up the <code>/scheme/initfs</code> scheme, and loads and executes the <code>init</code> program.</p>
<p>The kernel creates three different namespaces during the bootstrap process. Each namespace has its schemes that can be accessed by userspace programs, depending on where it is loaded:</p>
<ol>
<li>
<p>the <code>null</code> (0) namespace, a namespace that drivers are running on:</p>
<ul>
<li><code>/scheme/memory</code></li>
<li><code>/scheme/pipe</code></li>
</ul>
</li>
<li>
<p>the <code>root</code> (1) namespace, the initial namespace set up during boot:</p>
<ul>
<li><code>/scheme/kernel.acpi</code></li>
<li><code>/scheme/kernel.dtb</code></li>
<li><code>/scheme/kernel.proc</code></li>
<li><code>/scheme/debug</code></li>
<li><code>/scheme/irq</code></li>
<li><code>/scheme/serio</code></li>
</ul>
</li>
<li>
<p>Additional namespaces requested by user, also loaded for <code>root</code> namespace:</p>
<ul>
<li><code>/scheme/event</code></li>
<li><code>/scheme/memory</code></li>
<li><code>/scheme/pipe</code></li>
<li><code>/scheme/sys</code></li>
<li><code>/scheme/time</code></li>
</ul>
</li>
</ol>
<h2 id="init"><a class="header" href="#init">Init</a></h2>
<p>Redox has a multi-staged init process, designed to allow for the loading of storage drivers in a modular and configurable fashion. This is commonly referred to as an init RAMdisk (initfs). The RAMdisk is contained in <code>/boot/initfs</code>, which is a special file format containing the bootstrap code in ELF format and packed files which was loaded into <code>/scheme/initfs</code> by the kernel program.</p>
<h3 id="ramdisk-init"><a class="header" href="#ramdisk-init">RAMdisk Init</a></h3>
<p>The ramdisk init has the job of loading the drivers and daemons required to access the root filesystem and then transferring control to the filesystem init. The load order is defined in <code>/etc/init.rc</code> in initfs:</p>
<ol>
<li>Daemons required for <code>relibc</code>
<ul>
<li><code>rtcd</code> loads machine-specific RTC into <code>/scheme/time</code></li>
<li><code>nulld</code> null handler, creates <code>/scheme/null</code></li>
<li><code>zero</code> zero handler, creates <code>/scheme/zero</code></li>
<li><code>randd</code> rand handler, creates <code>/scheme/rand</code></li>
</ul>
</li>
<li>Logging
<ul>
<li><code>logd</code> system log handler, creates <code>/scheme/log</code></li>
<li><code>ramfs</code> loads in-memory FS handling into <code>/scheme/memory</code></li>
</ul>
</li>
<li>Graphics buffers
<ul>
<li><code>inputd</code> virtual terminal (VT) handler, creates <code>/scheme/input</code></li>
<li><code>vesad</code> VESA interface handler, creates <code>/scheme/display.vesa</code></li>
<li><code>fbbootlogd</code> forwards log from logd to VT</li>
<li><code>fbcond</code> handles keyboard interaction to VT</li>
</ul>
</li>
<li>Live daemon
<ul>
<li><code>lived</code> livedisk handler, creates <code>/scheme/disk.live</code></li>
</ul>
</li>
<li>Drivers in <code>/etc/init_drivers.rc</code>
<ul>
<li><code>ps2d</code> loads PS/2 handling into <code>/scheme/serio</code></li>
<li><code>acpid</code> loads ACPI handling into <code>/scheme/kernel.acpi</code></li>
<li><code>pcid</code> PCI handler, creates <code>/scheme/pci</code></li>
<li><code>pcid-spawner</code> spawns drivers depending on available hardware
<ul>
<li><code>ahcid</code> AHCI storage driver</li>
<li><code>ided</code> IDE storage driver</li>
<li><code>nvmed</code> NVME storage driver</li>
<li><code>virtio-blkd</code> VirtIO BLK storage driver</li>
<li><code>virtio-gpud</code> VirtIO GPU driver</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>After loading all drivers and daemons above, the <code>redoxfs</code> driver is executed with <code>--uuid $REDOXFS_UUID</code> where <code>$REDOXFS_UUID</code> is the partition chosen by the bootloader and creates <code>/scheme/file</code>. The command <code>set-default-scheme file</code> is then executed, so that the default path handler is set to <code>/scheme/file</code>.</p>
<h3 id="filesystem-init"><a class="header" href="#filesystem-init">Filesystem Init</a></h3>
<p>The filesystem init continues the loading of drivers for all other functionality. This includes audio, networking, and anything not required for storage device access. The drivers' init configuration is mainly found in <code>/usr/lib/init.d</code> and <code>/etc/pcid.d</code>. In the redox builder repository, it's configurable in the <a href="https://gitlab.redox-os.org/redox-os/redox/-/tree/master/config/base.toml">config directory</a>. After this, the login prompt is shown.</p>
<p>If Orbital is enabled, the display server is launched.</p>
<h2 id="login"><a class="header" href="#login">Login</a></h2>
<p>After the init processes have set up drivers and daemons, the user can log in to the system. The login program accepts a username, with a default user called <code>user</code>, prints the <code>/etc/motd</code> file, and then executes the user's login shell, usually <code>ion</code>. At this point, the user will now be able to access the <a href="./shell.html">shell</a></p>
<h2 id="graphical-overview"><a class="header" href="#graphical-overview">Graphical overview</a></h2>
<p>Here is an overview of the initialization process with scheme creation and usage. For simplicity's sake, we do not depict all scheme interaction but at least the major ones. <strong>this is currently out of date, but still informative</strong></p>
<p><img src="./assets/init.svg" alt="Redox initialization graph" title="Redox initialization graph" /></p>
<h2 id="boot-process-documentation"><a class="header" href="#boot-process-documentation">Boot process documentation</a></h2>
<ul>
<li><a href="https://wiki.osdev.org/Boot_Sequence">Boot process documentation</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="microkernels.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="kernel.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="microkernels.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="kernel.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
